<div id="formatterToolboxModal" class="modal"> <!-- Assuming SillyTavern uses a 'modal' class for popups -->
    <div class="modal-content">
        <span class="close-button" id="formatterToolboxClose">&times;</span>
        <h2>Formatter Toolbox</h2>

        <div class="formatter-tabs">
            <button class="tab-button active" data-tab="tab-general">General & Order</button>
            <button class="tab-button" data-tab="tab-find-replace">Find & Replace</button>
            <button class="tab-button" data-tab="tab-paragraph-control">Paragraph Control</button>
            <button class="tab-button" data-tab="tab-style-mapper">Style Mapper</button>
            <button class="tab-button" data-tab="tab-smart-punctuation">Smart Punctuation</button>
            <button class="tab-button" data-tab="tab-case-formatter">Case Formatter</button>
            <button class="tab-button" data-tab="tab-quick-action">Quick Actions</button>
            <button class="tab-button" data-tab="tab-tag-autoclose">Tag Auto-Close</button>
        </div>

        <div id="tab-general" class="tab-content active"> <!-- Ensure 'active' is set if it's the default tab -->
            <h4>General Settings</h4>
            <div class="formatter-setting-item">
                <label for="general-enable-formatter">Enable Formatter Toolbox (Master Switch):</label>
                <input type="checkbox" id="general-enable-formatter">
            </div>
            <div class="formatter-setting-item">
                <label for="general-auto-format">Enable Auto-Formatting on New Messages:</label>
                <input type="checkbox" id="general-auto-format">
            </div>

            <hr style="margin: 20px 0;">

            <h4>Automatic Tool Execution Order</h4>
            <p style="font-size: 0.9em; color: #555;">
                Drag and drop to reorder. The first tool in the list runs first.
                (Drag-and-drop functionality requires SortableJS library.)
            </p>
            <ul id="tool-order-list" style="list-style-type: none; padding-left: 0;">
                <!-- Tool order will be dynamically populated here -->
                <!-- Example static item (will be dynamic):
                     <li data-tool-id="FindAndReplaceTool" class="tool-order-item">1. Find & Replace</li>
                -->
            </ul>
        </div>
        <div id="tab-find-replace" class="tab-content">
               <h4>Find & Replace Rules</h4>
               <div id="fnr-rules-container">
                   <!-- Rules will be dynamically added here -->
               </div>
               <button id="fnr-add-rule" class="formatter-button">Add New Rule</button>
               <div id="fnr-rule-template" style="display: none;">
                   <div class="fnr-rule-item">
                       <input type="text" class="fnr-find" placeholder="Find (Text or Regex)">
                       <input type="text" class="fnr-replace" placeholder="Replace With">
                       <label><input type="checkbox" class="fnr-is-regex"> Regex</label>
                       <label><input type="checkbox" class="fnr-case-sensitive"> Case Sensitive</label>
                       <label><input type="checkbox" class="fnr-enabled" checked> Enabled</label>
                       <button class="fnr-delete-rule formatter-button delete">Delete</button>
                   </div>
               </div>
        </div>
        <div id="tab-paragraph-control" class="tab-content">
               <h4>Paragraph Control Settings</h4>
               <div class="formatter-setting-item">
                   <label for="pc-mode">Mode:</label>
                   <select id="pc-mode">
                       <option value="none">None (Disabled)</option>
                       <option value="single">Force Single Paragraph</option>
                       <option value="max">Allow Maximum Paragraphs</option>
                       <option value="min">Ensure Minimum Paragraphs (No change if less)</option>
                   </select>
               </div>
               <div class="formatter-setting-item pc-max-container" style="display: none;">
                   <label for="pc-max-paras">Max Paragraphs:</label>
                   <input type="number" id="pc-max-paras" min="1" value="3">
               </div>
               <div class="formatter-setting-item pc-min-container" style="display: none;">
                   <label for="pc-min-paras">Min Paragraphs:</label>
                   <input type="number" id="pc-min-paras" min="1" value="1">
               </div>
        </div>
        <div id="tab-style-mapper" class="tab-content">
               <h4>Style Mapper Rules</h4>
               <div id="sm-rules-container">
                   <!-- Rules will be dynamically added here -->
               </div>
               <button id="sm-add-rule" class="formatter-button">Add New Rule</button>
               <div id="sm-rule-template" style="display: none;">
                   <div class="sm-rule-item formatter-rule-item"> <!-- Added generic formatter-rule-item class -->
                       <input type="text" class="sm-name" placeholder="Rule Name (e.g., Italics)">
                       <input type="text" class="sm-find-regex" placeholder="Find Regex (e.g., \*([^\*]+?)\*)">
                       <input type="text" class="sm-tag-name" placeholder="Tag Name (e.g., thought)">
                       <input type="text" class="sm-replace-pattern" value="$TAG_START$1$TAG_END" placeholder="Replacement (use $1, $TAG_START, $TAG_END)">
                       <label><input type="checkbox" class="sm-enabled" checked> Enabled</label>
                       <button class="sm-delete-rule formatter-button delete">Delete</button>
                   </div>
               </div>
        </div>
        <div id="tab-smart-punctuation" class="tab-content">
               <h4>Smart Punctuation Settings</h4>
               <div class="formatter-setting-item">
                   <label for="sp-enabled">Enable Smart Punctuation:</label>
                   <input type="checkbox" id="sp-enabled">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-target-tag">Target Tag Name (from Style Mapper):</label>
                   <input type="text" id="sp-target-tag" placeholder="e.g., dialogue">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-positive-replacement">Positive Sentiment Replacement:</label>
                   <input type="text" id="sp-positive-replacement" class="text_pole" placeholder="e.g., !">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-negative-replacement">Negative Sentiment Replacement:</label>
                   <input type="text" id="sp-negative-replacement" class="text_pole" placeholder="e.g., ...">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-neutral-replacement">Neutral Sentiment Replacement:</label>
                   <input type="text" id="sp-neutral-replacement" class="text_pole" placeholder="e.g., .">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-positive-threshold">Positive Threshold:</label>
                   <input type="number" step="0.01" id="sp-positive-threshold" class="text_pole" placeholder="e.g., 0.05">
               </div>
               <div class="formatter-setting-item">
                   <label for="sp-negative-threshold">Negative Threshold:</label>
                   <input type="number" step="0.01" id="sp-negative-threshold" class="text_pole" placeholder="e.g., -0.05">
               </div>
        </div>
        <div id="tab-case-formatter" class="tab-content">
               <h4>Case Formatter Settings</h4>
               <div class="formatter-setting-item">
                   <label for="cf-sentence-case">Enable Sentence Case:</label>
                   <input type="checkbox" id="cf-sentence-case">
               </div>
               <!-- Add other case formatting options here in the future if needed -->
               <!-- e.g., Title Case, UPPERCASE all, lowercase all for specific tags -->
        </div>
        <div id="tab-quick-action" class="tab-content">
               <h4>Quick-Action Toolbar Settings</h4>
               <div class="formatter-setting-item">
                   <label for="qa-toolbar-enabled">Enable Quick-Action Toolbar on Text Selection:</label>
                   <input type="checkbox" id="qa-toolbar-enabled">
               </div>
               <p style="font-size: 0.9em; color: #555; margin-top: 10px;">
                   When enabled, selecting text in a chat message will show a small toolbar for quick formatting actions.
                   (Inspired by features seen in extensions like splitclover/rewrite-extension).
               </p>
        </div>
        <div id="tab-tag-autoclose" class="tab-content">
               <h4>Tag Auto-Close Settings</h4>
               <div class="formatter-setting-item">
                   <label for="tac-enabled">Enable Tag Auto-Close Assistance:</label>
                   <input type="checkbox" id="tac-enabled">
               </div>
               <p style="font-size: 0.9em; color: #555; margin-top: 10px;">
                   When enabled, if you click or type after an unclosed XML-style tag (e.g., <code>&lt;think&gt;</code>),
                   a small popup will offer to insert the corresponding closing tag (e.g., <code>&lt;/think&gt;</code>).
               </p>
        </div>
    </div>
</div>
